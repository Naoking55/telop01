# Premiere Pro prtextstyle バイナリフォーマット完全解析サマリー

**解析日**: 2025-12-12
**セッション**: グラデーションとシャドウパラメータの解明

---

## 🎯 セッションの成果

このセッションでは、prtextstyleバイナリフォーマットの**グラデーション色マッピング**と**シャドウパラメータ**の解析に成功しました。

---

## 📊 グラデーション解析の完全解明

### 重要な発見

1. **Position値は正しくグラデーション位置を表す**
   - 0.0 = 0% (開始点)
   - 0.3 = 30% (中間点)
   - 1.0 = 100% (終了点)

2. **色データの2つの形式**

   **形式1: RGBA Float** (16バイト)
   - 範囲: 0.0 - 1.0
   - 用途: グラデーション色（主に開始/終了色）
   - 例: 青 RGBA(0.0, 0.0, 1.0, 0.5) = 半透明青

   **形式2: RGB Bytes** (3バイト)
   - 範囲: 0 - 255
   - 用途: グラデーション色（主に中間色）
   - 例: 白 RGB(255, 255, 255), 赤 RGB(255, 0, 0)

3. **色とストップの空間的配置**

   **RGBA Float形式の場合**:
   ```
   [16バイト: RGBA Float] [8バイト: Position + Alpha]

   例:
   0x01d4: RGBA(0.0, 0.0, 1.0, 0.5) - 青色
   0x01d8: Position=1.0, Alpha=0.5   - ストップ（+4バイト後）
   ```

   **RGB Bytes形式の場合**:
   ```
   [8バイト: Position + Alpha] ... [3バイト: RGB White] ... [3バイト: RGB Red]

   例:
   0x0208: Position=0.3, Alpha=0.5   - ストップ
   0x0211: RGB(255, 255, 255)        - 白色（+9バイト後）
   0x0213: RGB(255, 0, 0)            - 赤色（+11バイト後）
   ```

### 検証方法

**30% vs 70%グラデーションの比較**で確認:
- 両ファイルとも**同じオフセット (0x0211)** に白色が存在
- 30%ファイル: Position=0.3 → 白色 ✅
- 70%ファイル: Position=0.7 → 白色 ✅

この一致により、Position値が正しくグラデーション位置を表すことを確認。

### グラデーションストップ構造

```
8バイト = [Position (float 4B)] [Alpha (float 4B)]

例:
0x0208: 9a 99 99 3e 00 00 00 3f
        └─ 0.3 ──┘ └─ 0.5 ──┘
```

### 中間点パラメータの発見

Position=0.0 だが Alpha値が可変のフロートが検出:
- 30%ファイル @ 0x0204: Position=0.0, **Alpha=0.30**
- 70%ファイル @ 0x0204: Position=0.0, **Alpha=0.70**

→ これはグラデーションの**中間点（Midpoint）**パラメータと推測

---

## 🎨 検出された色データのパターン

### 青白赤グラデーション (30%)

| 色 | 形式 | オフセット | 値 |
|----|------|----------|-----|
| 青 | RGBA Float | 0x0194, 0x01d4 | RGBA(0.0, 0.0, 1.0, 0.5) |
| 白 | RGB Bytes | 0x0211, 0x022d など | RGB(255, 255, 255) |
| 赤 | RGB Bytes | 0x0213, 0x022f など | RGB(255, 0, 0) |

### 4色グラデーション (10.25.75.90)

| 位置 | オフセット | Position値 | 備考 |
|------|----------|-----------|------|
| 90% | 0x01d4 | 0.900000 | 逆順で格納 |
| 75% | 0x01f4 | 0.750000 | |
| 25% | 0x020c | 0.251821 | |
| 10% | 0x0238 | 0.100000 | |

**注意**: グラデーションストップは**逆順**（100% → 0%）で格納される傾向

---

## 🔬 シャドウパラメータ解析

### 検出されたX,Yオフセットペア

Fontstyle_90 (1756バイト) から以下のシャドウオフセット候補を検出:

| オフセット | X値 | Y値 | 用途推定 |
|----------|-----|-----|---------|
| 0x009c | 0.00 | 2.00 | シャドウオフセット |
| 0x00a0 | 2.00 | 2.00 | シャドウオフセット（重複？） |
| 0x0478 | 4.00 | 11.00 | シャドウオフセット |
| 0x020c | 4.00 | 20.00 | シャドウオフセット |
| 0x0524 | 0.00 | 1.00 | 特殊パラメータ |

### パターン観察

1. **値の重複パターン**:
   - X=4.00, Y=20.00 @ 0x020c
   - X=20.00, Y=0.00 @ 0x0210 (4バイト後)

   → 同じ値が**スワップされて**格納される傾向

2. **色との位置関係**:
   - シャドウオフセットの周辺（±40バイト）に黒色 RGBA が存在
   - 例: 0x0524 (X,Y) の-4バイトに青 @ 0x0520
   - 例: 0x0478 (X,Y) の+8バイトに黒 @ 0x0480

### シャドウ色の候補

**非ゼロアルファの黒色** (実際のシャドウ色と推測):
- Alpha=1.0 (不透明黒): 0x0108, 0x0194, 0x01d0
- Alpha=0.5 (半透明黒): 0x01ac, 0x01f0

---

## 🧩 ストロークパラメータ（前セッションからの継続）

### 184バイト差分の解析結果

| パラメータ | オフセット | 形式 | 値 |
|-----------|----------|------|-----|
| ストローク幅 | 0x0184 | float32 | 16.0 pt |
| ストローク不透明度 | 0x0180 | float32 | 100.0 |
| ストローク色1 | 0x01bc | RGBA float | RGB(0, 0, 255, 127) |
| ストローク色2 | 0x01ec | RGBA float | RGB(0, 0, 255, 127) |

**ストローク1つあたり**: 約184バイト

---

## 📐 FlatBuffersデータ構造

### ヘッダー

```
Offset  Data                       Meaning
------  -------------------------  -------------------------
0x0000  9c 02 00 00                Total size (668 bytes)
0x0004  00 00 00 00                Reserved
0x0008  44 33 22 11                FlatBuffers magic number
0x000c  0c 00 00 00                VTable offset
```

### VTableによる動的レイアウト

FlatBuffersはVTable構造により、パラメータのオフセットが動的に変化:
- 固定オフセットに依存しない設計が必要
- パターンマッチングでパラメータを検出するのが安全

---

## 🛠️ 実装への応用

### Phase 1: 基本的なグラデーション生成

**2色グラデーション（青→白）の生成**:
1. RGBA Float形式で青色を書き込み (16バイト @ offset_start)
2. Position=0.0, Alpha=0.5を書き込み (8バイト @ offset_start+16)
3. RGB Bytes形式で白色を書き込み (3バイト @ offset_mid+9)
4. Position=1.0, Alpha=0.5を書き込み (8バイト @ offset_end)

**3色グラデーション（青→白→赤）の生成**:
1. 青色 RGBA float @ offset1
2. 白色 RGB bytes @ offset2+9
3. 赤色 RGB bytes @ offset2+11
4. ストップ位置を0.0, 0.3, 1.0で設定

### Phase 2: ストローク付きスタイル生成

**テンプレートベースアプローチ**:
```python
# 916バイトのストローク付きテンプレートを使用
template = load_template("stroke_template_916.prtextstyle")

# ストローク幅を変更
template[0x184:0x188] = struct.pack("<f", stroke_width)

# ストローク色を変更（RGBA float）
r, g, b, a = stroke_color_rgba_normalized  # 0.0-1.0
# 注意: 最初の8バイトはメタデータの可能性あり、RGBAは後半8バイト
template[0x1bc+8:0x1bc+16] = struct.pack("<ff", b, a)
template[0x1ec+8:0x1ec+16] = struct.pack("<ff", b, a)
```

### Phase 3: シャドウ付きスタイル生成

**シャドウパラメータの設定**:
```python
# シャドウX,Yオフセット
shadow_x = 4.0  # ピクセル
shadow_y = 11.0 # ピクセル

# オフセット位置に書き込み（例: 0x0478）
binary[shadow_offset:shadow_offset+4] = struct.pack("<f", shadow_x)
binary[shadow_offset+4:shadow_offset+8] = struct.pack("<f", shadow_y)

# シャドウ色（黒・半透明）
shadow_rgba = (0.0, 0.0, 0.0, 0.5)  # RGBA float
binary[shadow_color_offset:shadow_color_offset+16] = struct.pack("<ffff", *shadow_rgba)
```

---

## 📊 解析ツール一覧

| ツール | 用途 |
|--------|------|
| `analyze_gradient_stops.py` | 2色グラデーション比較 (30% vs 70%) |
| `analyze_4color_gradient.py` | 4色グラデーション解析 |
| `analyze_complete_gradient_structure.py` | 完全なグラデーション構造マッピング |
| `analyze_rgba_float_colors.py` | RGBA float形式の色検出 |
| `compare_30_70_gradients.py` | 30%/70%グラデーションの完全比較 |
| `analyze_shadow_parameters.py` | シャドウパラメータ解析 |
| `analyze_184byte_difference.py` | ストローク差分解析 |
| `analyze_100_200_styles.py` | 300スタイルの統計解析 |

---

## 📚 ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `GRADIENT_COLOR_MAPPING.md` | グラデーション色マッピングの詳細 |
| `STROKE_ANALYSIS_FINDINGS.md` | ストロークパラメータの発見 |
| `MULTI_STYLE_ANALYSIS.md` | 300スタイルの解析結果 |
| `FINAL_BINARY_FORMAT_FINDINGS.md` | バイナリフォーマットの基本構造 |

---

## ✅ 確定した事実

1. **グラデーションストップ**: 8バイト = [Position 4B][Alpha 4B]
2. **Position値**: 0.0-1.0がグラデーション位置を正確に表す
3. **色データ形式**: RGBA Float (16B) と RGB Bytes (3B) の2種類
4. **色の配置パターン**:
   - RGBA float: ストップの4バイト前
   - RGB bytes: ストップの+9, +11バイト後
5. **ストローク幅**: 0x0184付近に float32
6. **ストロークサイズ**: 1ストロークあたり約184バイト
7. **シャドウオフセット**: X,Yペアとして8バイト (float x 2)
8. **FlatBuffersフォーマット**: マジックナンバー 0x44332211

---

## ❓ 未解決の課題

### 優先度 HIGH

1. **シャドウパラメータの完全解明**
   - シャドウ色の正確な位置
   - ぼかし（Blur）パラメータの位置
   - シャドウ有無を制御するフラグ

2. **グラデーション方向/角度**
   - 線形グラデーションの角度パラメータ
   - 放射状グラデーションの対応

3. **中間点パラメータの詳細**
   - 0x0204の Alpha値=中間点の仮説を検証
   - 複数の中間点を持つグラデーションの構造

### 優先度 MEDIUM

4. **ストローク位置パラメータ**
   - 内側/外側/中央の違いを表すフラグ
   - ※ PRSLは基本外側なので優先度低

5. **より多くのスタイルサンプル**
   - 200 New FontStyles_01.prtextstyleの完全解析
   - 参考ファイルまとめ.prtextstyleの解析

---

## 🚀 次のステップ

1. **シャドウパラメータの確定**
   - 異なるシャドウ設定を持つスタイルを比較
   - ぼかし、オフセット、色の完全なマッピング

2. **完全な実装ガイドの作成**
   - Python実装サンプルコード
   - テンプレート選択ロジック
   - エラーハンドリング

3. **prsl_converterへの統合**
   - グラデーション生成機能の実装
   - ストローク生成機能の実装
   - シャドウ生成機能の実装（準備完了後）

---

## 📝 コミット履歴

1. `49e5cb7` - Add comprehensive format specifications v2.0
2. `0c88eb1` - BREAKTHROUGH: Color data format completely decoded
3. `9ae31f5` - Add comprehensive format specifications v2.0
4. `9f615f9` - MAJOR BREAKTHROUGH: Gradient color mapping decoded
5. `1b11396` - Add shadow parameter analysis tools

---

**結論**: グラデーションの色マッピングとストロークパラメータの解明により、基本的なスタイル生成の実装が可能なレベルに到達。シャドウパラメータの詳細解明が残る課題。
