# Premiere Pro 2025 prtextstyle Binary Format Specification

## 概要

Premiere Pro 2025 の `.prtextstyle` ファイルは、以下の構造を持つ：

1. **XML外部構造**: PremiereData Version="3" プロジェクト形式
2. **バイナリデータ**: `ArbVideoComponentParam` の `StartKeyframeValue` 内にBase64エンコードされた FlatBuffers 形式のバイナリデータ

## バイナリフォーマット詳細

### 基本情報

- **形式**: FlatBuffers (Google製のシリアライゼーションライブラリ)
- **エンディアン**: Little Endian
- **サイズ**: 可変長 (450-500 bytes 程度、内容により変動)

### ヘッダー構造

```
0x0000-0x0003: ルートテーブルへのオフセット (uint32)
0x0004-0x0007: 未使用 (00 00 00 00)
0x0008-0x000b: マジックナンバー "D3\"\x11" (44 33 22 11)
0x000c以降: FlatBuffersデータ本体
```

### 主要なデータ領域

#### 1. VTable領域 (0x00b0付近)

FlatBuffersのVTable（仮想テーブル）。各フィールドへのオフセットを格納。
- オフセット値は符号付き32bit整数
- -1 (0xffffffff) は「フィールドなし」を示す
- 正の値はそのフィールドへの相対オフセット

#### 2. フォント名 (0x00d0付近 - ただし可変)

- **形式**: 長さプレフィックス付きUTF-8文字列
- **構造**:
  ```
  uint32: 文字列の長さ (bytes)
  bytes:  UTF-8エンコードされた文字列
  ```
- **例**: "VD-LogoG-Extra-G" (16 bytes)

**重要**: この位置は固定ではない！色データや他のプロパティによって位置が変動する。

#### 3. 数値データ領域 (0x0090-0x01c0)

以下のデータが含まれる（位置は可変）：

- **フォントサイズ**: float値
  - 例: 30.0 (0x00 00 f0 41)
  - 例: 24.0 (0x00 00 c0 41)
  - 例: 50.0 (0x00 00 48 42)

- **寸法値**: uint32 × 3
  - 例: 白の場合 `18 00 00 00 18 00 00 00 18 00 00 00` (24, 24, 24)
  - 例: 赤の場合 `1c 00 00 00 1c 00 00 00 1c 00 00 00` (28, 28, 28)

- **浮動小数点値**:
  - `189.933` (0xd9 ee 3d 43): 用途不明だが多くのファイルに出現
  - `5.698` (0xef 55 b6 40): 赤と青のファイルに出現
  - `11.396` (0xef 55 36 41): 赤のファイルに特有
  - `18.000` (0x00 00 90 41): 白のファイルに出現
  - `49.396` (0x7c 95 45 42): 白のファイルに出現

#### 4. "Aa" 文字列 (ファイル末尾付近)

- サンプルテキストとして "Aa" が格納されている
- 位置: 0x01bc 付近（ただし可変）

## ファイルサイズの違い

- **白（ストロークなし）**: 452 bytes
- **赤（ストロークなし）**: 480 bytes
- **青（ストロークなし）**: 476 bytes
- **白（ストロークあり）**: 456 bytes

→ **結論**: 色やストロークの有無によってバイナリサイズが変動する

## 色データの格納方法

### 現在の解析状況

色データの正確な位置とフォーマットは **まだ完全には特定できていない**。

### 候補となる差分箇所

#### 差分1: 0x00b0-0x00b2
```
White: fc fe
Red:   10 ff
Blue:  50 ff
```

#### 差分2: 0x00b4
```
White: 00
Red:   14
Blue:  54
```

#### 差分3: 0x00b8-0x00c0
```
White: 04 ff ff ff 2a ff ff ff
Red:   04 00 06 00 04 00 00 00
Blue:  58 ff ff ff 0a ff ff ff
```

これらはVTableのオフセット値である可能性が高い。

### 色データの可能性が高い領域

1. **FlatBuffersの構造上、色データは別の場所に格納されている**
2. **VTableのオフセットが色によって異なる** = データレイアウトが異なる
3. **float形式 (0.0-1.0) のRGBAが格納されているはずだが、直接は見つからない**

### 仮説

1. **色データは圧縮されている可能性**
2. **色データはインデックス化されている可能性** (パレット方式)
3. **色データは別のテーブルに間接参照されている**
4. **FlatBuffersの階層構造の奥に格納されている**

## FlatBuffers構造の推定

```
table SourceText {
  font_name: string;
  font_size: float;
  dimensions: [uint32];
  color_data: ColorInfo;  // ← この構造が不明
  sample_text: string;
  ... other fields ...
}

table ColorInfo {
  // 構造不明
  // R, G, B, A がどこかにあるはず
}
```

## 次に必要な作業

### 1. FlatBuffersスキーマの完全解明

- FlatBuffers公式ツール (`flatc`) で逆コンパイルを試みる
- または、手動でバイナリを解析して完全なスキーマを再構築

### 2. 色データの特定

以下の方法を試す：

a) **追加のテストファイル作成**
   - 中間色（グレー、赤50%など）のファイルを作成
   - バイナリを比較して色値を特定

b) **グラデーションファイルの解析**
   - `青白グラ・ストローク無し.prtextstyle`
   - `青白赤グラ・ストローク無し.prtextstyle`
   - 複数の色値が含まれるため、色の格納場所が特定しやすい

c) **Premiere Pro プラグインSDKの調査**
   - Adobe After Effects SDK に含まれるテキストレイヤー関連のヘッダーファイル
   - FlatBuffersスキーマ定義ファイル (.fbs) が含まれている可能性

### 3. 完全なエンコーダーの実装

色データの位置が特定でき次第：

1. FlatBuffersライブラリ（Python: `flatbuffers`）を使用
2. 正確なバイナリを生成
3. Premiere Pro 2025でインポートテスト

## 暫定的な実装方針

### アプローチA: テンプレート方式（推奨）

1. 参考ファイル（白・赤・青など）をテンプレートとして使用
2. フォント名、フォントサイズなど、位置が確定している部分のみ置換
3. 色データは参照ファイルから選択

**メリット**:
- 確実に動作する
- 実装が簡単
- すぐに使える

**デメリット**:
- テンプレートにない色は作成できない
- 柔軟性が低い

### アプローチB: 完全解析方式

1. バイナリフォーマットを完全に解明
2. ゼロから正確なバイナリを生成

**メリット**:
- 任意の色・設定が可能
- 完全な柔軟性

**デメリット**:
- 解析に時間がかかる
- 複雑

## 参考情報

### FlatBuffers

- 公式サイト: https://google.github.io/flatbuffers/
- Python ライブラリ: `pip install flatbuffers`
- スキーマコンパイラ: `flatc`

### Adobe SDK

- After Effects SDK: https://developer.adobe.com/after-effects/
- Premiere Pro SDK: https://developer.adobe.com/premiere-pro/

## 付録: バイナリダンプ比較

### 白 (TEMPLATE_SolidFill_White.prtextstyle)

```
0000:  b8 01 00 00 00 00 00 00 44 33 22 11 0c 00 00 00
0010:  00 00 06 00 0a 00 04 00 06 00 00 00 64 00 00 00
...
00d0:  56 44 2d 4c 6f 67 6f 47 2d 45 78 74 72 61 2d 47  (VD-LogoG-Extra-G)
...
```

### 赤 (赤・ストローク無し.prtextstyle)

```
0000:  d4 01 00 00 00 00 00 00 44 33 22 11 0c 00 00 00
0010:  00 00 06 00 0a 00 04 00 06 00 00 00 64 00 00 00
...
00d0:  00 00 00 00 01 00 00 00 04 00 00 00 10 00 00 00  (異なる！)
00e0:  56 44 2d 4c 6f 67 6f 47 2d 45 78 74 72 61 2d 47  (フォント名がずれている)
...
```

## 更新履歴

- 2025-12-12: 初版作成
  - FlatBuffers形式であることを確認
  - フォント名、サイズの位置を特定（可変）
  - 色データの位置は未特定
