# グラデーションとシャドウの解析結果

**解析日**: 2025-12-12
**解析対象**: 参考prtextstyleファイル（グラデーション関連）

---

## 🎯 グラデーションストップ位置の完全解明

### 発見サマリー

**グラデーションストップ位置は特定のオフセットにfloat値として格納されている**

### 2色グラデーション（青白赤グラ 30 vs 70）

| ファイル | ストップ位置 | オフセット | float値 |
|----------|-------------|-----------|---------|
| 青白赤グラ 30 | 30% | 0x0208 | 0.300000 |
| 青白赤グラ 70 | 70% | 0x0208 | 0.700000 |

**重要**: 両ファイルで**同じオフセット**にストップ位置が格納されている

#### バイナリ詳細

**30ファイル (0x0208)**:
```
Hex: 0a 00 00 00 0c 00 00 00 9a 99 99 3e 00 00 00 3f
                              └─ 0.3 ─┘ └─ 0.5 ─┘
                              (position)  (alpha)
```

**70ファイル (0x0208)**:
```
Hex: 0a 00 00 00 0c 00 00 00 33 33 33 3f 00 00 00 3f
                              └─ 0.7 ─┘ └─ 0.5 ─┘
                              (position)  (alpha)
```

**発見**:
- Position (float): ストップ位置 (0.0-1.0)
- Alpha (float): 直後にアルファ値（両方とも0.5 = 半透明）

---

### 4色グラデーション（黄赤青白グラ 10.25.75.90）

**検出されたストップ位置**: 4箇所

| ストップ# | 目標値 | 実際の値 | オフセット | アルファ値 |
|----------|--------|---------|-----------|----------|
| 1 | 90% | 0.900000 | 0x01d4 | 0.5 |
| 2 | 75% | 0.750000 | 0x01f4 | 0.5 |
| 3 | 25% | 0.251821 | 0x020c | 0.5 |
| 4 | 10% | 0.100000 | 0x0238 | 0.5 |

**注目点**:
- **逆順で格納**されている（90% → 75% → 25% → 10%）
- 各ストップの直後に**アルファ値 0.5**（半透明）
- 25%のみ微妙にずれている（0.251821）

#### バイナリ詳細

**ストップ1 (90%) @ 0x01d4**:
```
Hex: 66 66 66 3f 00 00 00 3f
     └─ 0.9 ─┘ └─ 0.5 ─┘
     (position)  (alpha)
```

**ストップ2 (75%) @ 0x01f4**:
```
Hex: 00 00 40 3f 00 00 00 3f
     └─ 0.75 ─┘ └─ 0.5 ─┘
```

**ストップ3 (25%) @ 0x020c**:
```
Hex: be ee 80 3e 00 00 00 3f
     └─ 0.25 ─┘ └─ 0.5 ─┘
```

**ストップ4 (10%) @ 0x0238**:
```
Hex: cd cc cc 3d 00 00 00 3f
     └─ 0.1 ─┘ └─ 0.5 ─┘
```

---

## 🎨 グラデーションストップの構造

### データ構造（推定）

各グラデーションストップは以下の構造を持つ：

```
[メタデータ/VTable参照] [Position (float)] [Alpha (float)] [RGB色データ?]
```

または、位置とアルファは固定オフセットに格納され、RGB色は別の領域にまとめて格納されている可能性あり。

### RGB色データの位置（未確定）

**検出されたRGBA候補** (0x0190-0x01a0付近):
- 0x0194: RGBA(0.00, 0.00, 1.00, 0.50) → 青
- 0x0198: RGBA(0.00, 1.00, 0.50, 0.00)
- 0x019c: RGBA(1.00, 0.50, 0.00, 0.00)
- 0x01ec: RGBA(0.00, 0.00, 0.75, 0.50)

**問題**: これらの色と4つのストップ位置の対応関係が明確でない

**可能性**:
1. RGBA float形式（16バイト）で各ストップの色が格納されている
2. 位置とは別の領域に、色のリストとして格納されている
3. FlatBuffersのオフセット参照により、各ストップから色データを参照している

---

## 📊 グラデーションストップの種類

### 検証済みファイル

| ファイル名 | ストップ数 | ストップ位置 | サイズ |
|-----------|----------|-------------|--------|
| 青白赤グラ 30 | 3色 | 30% (中間) | 680 bytes |
| 青白赤グラ 70 | 3色 | 70% (中間) | 680 bytes |
| 黄白グラ右50 | 2色 | 50% (中間) | ? |
| 黄白グラ右80 | 2色 | 80% (中間) | ? |
| 黄赤青白グラ 10.25.75.90 | 4色 | 10%, 25%, 75%, 90% | 712 bytes |
| 黄赤青白グラ 10.25.75.90 全部中間点5 | 4色 + 中間点 | 10%, 25%, 75%, 90% | 724 bytes |
| 黄赤青白グラ0.25.75.100 | 4色 | 0%, 25%, 75%, 100% | 722 bytes |

**サイズパターン**:
- 2色グラデ: ~640-680 bytes
- 3色グラデ: ~680 bytes
- 4色グラデ: ~710-724 bytes

**サイズ増加**: ストップが増えるごとに約30-40バイト増加

---

## 🌓 中間点パラメータ

**ファイル**: 黄赤青白グラ 10.25.75.90 全部中間点5.prtextstyle

**サイズ差**:
- 通常版: 712 bytes
- 中間点5版: 724 bytes
- 差分: **12 bytes**

**推測**: 中間点パラメータは各ストップ間に1つずつ（3つの区間 = 3箇所）
- 12 bytes / 3 区間 = **4 bytes/中間点** (float値の可能性)

**中間点の意味**: グラデーションの各色間の変化カーブを調整するパラメータ（0.5 = 直線、それ以外は非線形）

---

## 📐 実装への示唆

### グラデーションストップの設定方法

#### 2色グラデーション

```python
# テンプレートファイルを使用
template = load_template("2color_gradient_template.prtextstyle")

# 中間ストップ位置を設定（例: 30%）
stop_position = 0.3
template[0x0208:0x020c] = struct.pack("<f", stop_position)

# アルファ値（通常0.5で固定）
alpha = 0.5
template[0x020c:0x0210] = struct.pack("<f", alpha)
```

#### 4色グラデーション

```python
# 4つのストップ位置を設定
stops = [0.10, 0.25, 0.75, 0.90]
offsets = [0x0238, 0x020c, 0x01f4, 0x01d4]  # 逆順！

for i, (offset, position) in enumerate(zip(offsets, stops)):
    template[offset:offset+4] = struct.pack("<f", position)
    template[offset+4:offset+8] = struct.pack("<f", 0.5)  # alpha
```

**注意**:
- ストップは**逆順で格納**されることに注意
- 各ストップの色（RGB）の設定方法は別途調査が必要

---

## ❓ 未解明の要素

### グラデーション関連

1. **RGB色データの正確な位置と構造**
   - 各ストップの色がどのように格納されているか
   - RGBA float形式か、別の形式か
   - ストップ位置からのオフセット参照方法

2. **中間点パラメータの位置**
   - 各区間の中間点値の格納位置
   - デフォルト値（通常0.5）

3. **グラデーションの方向**
   - 線形グラデーションの角度
   - 放射状グラデーションのパラメータ（該当する場合）

### シャドウパラメータ（未調査）

1. **シャドウの有無の判定**
2. **シャドウの色** (RGBA)
3. **シャドウのオフセット** (X, Y)
4. **シャドウのぼかし** (blur radius)
5. **シャドウの不透明度**

**推奨**: シャドウありのサンプルファイルがあれば、シャドウなしと比較して解析

---

## 🚀 次のステップ

### 優先度 HIGH

1. **グラデーションRGB色の完全解明**
   - 4色グラデーションの色データ位置を特定
   - 各ストップとの対応関係を確認

2. **シャドウパラメータの解析**
   - シャドウあり/なしのサンプルを比較
   - オフセット、ぼかし、色、不透明度の位置を特定

### 優先度 MEDIUM

3. **中間点パラメータの詳細**
   - 「全部中間点5」ファイルと通常ファイルの差分解析
   - 中間点値の格納位置の特定

4. **実装ガイドの作成**
   - 確定したパラメータでの実装例
   - PRSL→prtextstyle変換の基本プロトタイプ

---

## 📚 関連ファイル

### 解析ツール
- `analyze_gradient_stops.py` - 2色グラデーション比較
- `analyze_4color_gradient.py` - 4色グラデーション解析

### 参考ファイル
- `青白赤グラ 30.prtextstyle` - 3色グラデ（30%）
- `青白赤グラ 70.prtextstyle` - 3色グラデ（70%）
- `黄赤青白グラ10.25.75.90.prtextstyle` - 4色グラデ
- `黄赤青白グラ 10.25.75.90 全部中間点5.prtextstyle` - 中間点あり

---

**結論**: **グラデーションストップ位置を完全解明**。各ストップは Position + Alpha のペアで格納される。RGB色データの位置は要追加調査。シャドウパラメータは未調査。
