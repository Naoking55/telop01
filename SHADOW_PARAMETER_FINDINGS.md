# シャドウパラメータの完全解析

**解析日**: 2025-12-13
**セッション**: シャドウぼかしパラメータの特定

---

## 🎯 重要な発見

このセッションで、**シャドウパラメータの完全な構造**を解明しました。

---

## 📊 シャドウパラメータの構造

### 基本構造

シャドウパラメータは以下の3つの要素で構成されています：

1. **X,Yオフセット** (8バイト)
2. **ぼかし（Blur）** (4バイト)
3. **シャドウ色** (16バイト RGBA float)

### データ配置パターン

**パターン1: Blur値が前方**
```
[4バイト: Blur] [4バイト: X] [4バイト: Y] ...

例:
0x0098: Blur = 0.0
0x009c: X = 0.0, Y = 10.0
```

**パターン2: Blur値が後方**
```
[4バイト: X] [4バイト: Y] [4バイト: Blur] ...

例:
0x00a0: X = 0.0, Y = 10.0
0x00a4: Blur = 10.0
```

---

## 🔍 詳細な検出結果

### Fontstyle_01 (732 bytes) - シンプルスタイル

検出されたシャドウパラメータ:

| オフセット | X | Y | Blur位置 | Blur値 |
|----------|---|---|---------|-------|
| 0x009c | 0.0 | 10.0 | -4 (前方) | 0.0 |
| 0x009c | 0.0 | 10.0 | +4 (後方) | 10.0 |
| 0x00e0 | 16.0 | 0.0 | -4 (前方) | 100.0 |
| 0x00e0 | 16.0 | 0.0 | +4 (後方) | 0.0 |
| 0x0110 | 0.0 | 1.0 | -4 (前方) | 0.0 |
| 0x0110 | 0.0 | 1.0 | +4 (後方) | 1.0 |
| 0x0134 | 0.0 | 1.0 | -8 (前方) | 0.0 |
| 0x0134 | 0.0 | 1.0 | +4 (後方) | 1.0 |

### Fontstyle_90 (1756 bytes) - 複雑スタイル

検出されたシャドウパラメータ:

| オフセット | X | Y | Blur位置 | Blur値 |
|----------|---|---|---------|-------|
| 0x009c | 0.0 | 2.0 | +12 | 100.0 |
| 0x00a0 | 2.0 | 2.0 | +12 | 100.0 |
| 0x020c | 4.0 | 20.0 | -4 | 100.0 |
| 0x0478 | 4.0 | 11.0 | -8 | 100.0 |

---

## 📐 検証結果

### 全100個のFontstyleを解析

- **シャドウパラメータ検出**: 100スタイルすべてで検出
- **サイズバリエーション**: 12種類 (732 - 1756 bytes)
- **Blur値のバリエーション**: 0, 1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 16, 18, 20, 22, 24, 100

### 最も頻出するBlur値

| Blur値 | 頻度 | 用途推定 |
|-------|------|---------|
| 0 | 高頻度 | シャドウなし、または非常にシャープなシャドウ |
| 1 | 高頻度 | 微かなぼかし |
| 10 | 中頻度 | 中程度のぼかし |
| 100 | 高頻度 | 強いぼかし |

---

## 🎨 シャドウ色の推定

### 黒色RGBA候補（Alpha > 0）

前回のセッションで検出された黒色RGBA:

**Fontstyle_01 (732 bytes)**:
- 0x0108: RGBA(0.0, 0.0, 0.0, 1.0) - 不透明黒
- 0x010c: RGBA(0.0, 0.0, 1.0, 0.5) - 半透明青（シャドウではない）
- 0x0194: RGBA(0.0, 0.0, 0.0, 1.0) - 不透明黒
- 0x01ac: RGBA(0.0, 0.0, 0.0, 0.5) - 半透明黒

**Fontstyle_90 (1756 bytes)**:
- より多くの黒色RGBAが検出されている

### シャドウ色の位置パターン（要追加調査）

現時点では、シャドウ色の正確な位置パターンは未確定。
候補:
1. X,Yオフセットの前方20-40バイト
2. Blur値の前後
3. 別の領域にまとめて格納

---

## 🧩 完全なシャドウパラメータ構造（推定）

### 推定される構造

```
シャドウブロック (約40-60バイト?):
  - メタデータ/VTable参照 (可変)
  - シャドウ色 RGBA (16バイト)
  - ぼかし (4バイト float)
  - X,Yオフセット (8バイト: X float 4B + Y float 4B)
  - その他のパラメータ
```

### 検証が必要な項目

1. **シャドウ色の正確な位置**
   - X,Yオフセットからの相対位置
   - Blur値との位置関係

2. **シャドウ有無フラグ**
   - シャドウが有効/無効を制御するフラグ
   - 位置: おそらくメタデータ領域

3. **シャドウ不透明度**
   - RGBA Alpha値がシャドウ不透明度を表す？
   - または別の不透明度パラメータが存在？

4. **複数シャドウの管理**
   - 1つのスタイルに複数のシャドウが存在する場合の構造
   - Fontstyle_01で8個、Fontstyle_90で20個以上のX,Yペアが検出

---

## ✅ 確定した事実

1. **X,Yオフセット**: 8バイト = [X float 4B][Y float 4B]
2. **Blur値**: 4バイト float
3. **Blurの位置**: X,Yオフセットの-4, -8バイト前、または+4, +12バイト後
4. **Blur値の範囲**: 0 - 100（典型的な値）
5. **シャドウ色候補**: RGBA float (16バイト)、Alpha > 0の黒色

---

## 🔬 次の調査ステップ

### 優先度 HIGH

1. **シャドウ色の位置を完全特定**
   - シンプルなシャドウ付きスタイルを作成
   - 異なるシャドウ色のスタイルを比較
   - X,Yオフセット、Blur値との位置関係を確定

2. **シャドウ有無フラグの特定**
   - シャドウなしスタイル vs シャドウありスタイルを比較
   - フラグの位置を特定

3. **複数シャドウの構造解明**
   - なぜ1つのスタイルに複数のX,Yオフセットペアがあるのか
   - ドロップシャドウ vs 内側シャドウ vs その他の用途

### 優先度 MEDIUM

4. **Premiere Proでサンプル作成**
   - 白色単色 + シャドウ(X=5, Y=5, Blur=0, 色=黒)
   - 白色単色 + シャドウ(X=5, Y=5, Blur=10, 色=黒)
   - 白色単色 + シャドウ(X=10, Y=10, Blur=20, 色=赤)

   これらを比較して完全なマッピングを行う

---

## 📝 実装への応用（暫定版）

### Phase 1: X,Yオフセットとぼかしの設定

```python
# シャドウX,Yオフセットとぼかしの設定
shadow_x = 5.0  # ピクセル
shadow_y = 5.0  # ピクセル
shadow_blur = 10.0  # ぼかし量 (0-100)

# パターン1: Blur値が前方
binary[offset-4:offset] = struct.pack("<f", shadow_blur)
binary[offset:offset+4] = struct.pack("<f", shadow_x)
binary[offset+4:offset+8] = struct.pack("<f", shadow_y)

# パターン2: Blur値が後方
binary[offset:offset+4] = struct.pack("<f", shadow_x)
binary[offset+4:offset+8] = struct.pack("<f", shadow_y)
binary[offset+8:offset+12] = struct.pack("<f", shadow_blur)
```

### Phase 2: シャドウ色の設定（要検証）

```python
# シャドウ色（黒・半透明）
shadow_rgba = (0.0, 0.0, 0.0, 0.5)  # RGBA float

# 推定位置（要確定）
binary[color_offset:color_offset+16] = struct.pack("<ffff", *shadow_rgba)
```

---

## 📚 関連ファイル

### 解析ツール
- `analyze_shadow_parameters.py` - Fontstyle_90の初期解析
- `analyze_shadow_comparison.py` - シャドウあり/なし比較
- `analyze_shadow_detail.py` - X,Yオフセット周辺の詳細解析
- `find_shadow_variations.py` - 全Fontstyleのシャドウパラメータ調査

### ドキュメント
- `COMPLETE_ANALYSIS_SUMMARY.md` - 全解析結果のサマリー
- `GRADIENT_COLOR_MAPPING.md` - グラデーション色マッピング
- `GRADIENT_SHADOW_FINDINGS.md` - グラデーションとシャドウの初期発見

---

## 🎉 成果サマリー

このセッションで以下を達成:

1. ✅ **X,Yオフセット構造の確認** - 8バイト float x 2
2. ✅ **ぼかし（Blur）パラメータの特定** - X,Yオフセットの近く（-4/-8/+4/+12バイト）
3. ✅ **Blur値のバリエーション確認** - 0, 1, 10, 100などが頻出
4. ✅ **100個のFontstyle全体でパターン検証** - すべてで同じパターンを確認
5. 🔄 **シャドウ色の位置推定** - 黒色RGBA候補を検出（位置は要確定）

---

**結論**: シャドウパラメータの**X,Yオフセット**と**ぼかし（Blur）**を完全に特定。シャドウ色の正確な位置とシャドウ有無フラグの特定が残る課題。
