# prtextstyle Binary Format Analysis - 完全レポート

## 解析日時
2025-12-12

## 重要な発見

### 1. FlatBuffers形式であることを確認

- **形式**: Google FlatBuffers
- **マジックナンバー**: `44 33 22 11` (0x0008-0x000b)
- **特徴**: 可変長フィールド、VTable方式のオフセット管理

### 2. ファイルサイズの変動

| ファイル | サイズ | 説明 |
|---------|--------|------|
| 白（単色）| 452 bytes | ベースライン |
| 赤（単色）| 480 bytes | +28 bytes |
| 青（単色）| 476 bytes | +24 bytes |
| 白（ストロークあり）| 456 bytes | +4 bytes |
| 青白グラデ | 632 bytes | +180 bytes |
| 青白赤グラデ | 680 bytes | +228 bytes |

**結論**: 色の種類、ストローク、グラデーションによってバイナリサイズが動的に変化

### 3. グラデーションファイルでの重大な発見

#### RGBA float値を発見！

グラデーションファイル内で **RGBA float (0.0-1.0)** 形式の色データを確認：

```
BlueWhite グラデーション (632 bytes):
  0x0194: R=0.000, G=0.000, B=1.000, A=0.500
  0x01d4: R=0.000, G=0.000, B=1.000, A=0.500

BlueWhiteRed グラデーション (680 bytes):
  0x0194: R=0.000, G=0.000, B=1.000, A=0.500
  0x01d4: R=0.000, G=0.000, B=1.000, A=0.500
```

**重要**: 単色ファイル（白、赤、青）には **このパターンが見つからない**

#### 考察

1. **グラデーション専用の色格納方式**
   - グラデーションストップごとにRGBA float値を格納
   - 位置: 0x0190-0x0200 付近

2. **単色は異なる方式？**
   - 可能性A: より圧縮された形式
   - 可能性B: インデックス参照
   - 可能性C: デフォルト値として省略

### 4. バイト単位比較の重要な差分

#### White vs Red vs Blue（全て異なる箇所）

```
0x00d0-0x00f1 (33 bytes):
  White: 56442d4c6f676f472d45787472612d47  ("VD-LogoG-Extra-G")
  Red:   00000000010000000400000010000000  (異なる構造！)
  Blue:  56442d4c6f676f472d45787472612d47  ("VD-LogoG-Extra-G")
```

**結論**: Redファイルは他と異なるデータレイアウトを持つ

### 5. 特定できた要素

| 要素 | 位置 | 形式 | 備考 |
|------|------|------|------|
| ルートオフセット | 0x0000-0x0003 | uint32 | FlatBuffersルート |
| マジックナンバー | 0x0008-0x000b | 固定値 | `44 33 22 11` |
| VTable | 0x00b0付近 | int32配列 | オフセット値、-1=null |
| フォント名 | 0x00d0付近（可変） | 長さ+UTF-8 | "VD-LogoG-Extra-G" |
| フォントサイズ | 0x0090付近 | float | 30.0, 24.0, 50.0 |
| サンプルテキスト | ファイル末尾付近 | 長さ+UTF-8 | "Aa" |

### 6. 未解決の謎

#### A. 単色ファイルの色データの位置

- White, Red, Blue の **RGBA float値が見つからない**
- VTableのオフセットが色によって異なる
- **仮説**: 色は別のエンコード方式で格納されている

#### B. 候補となる数値

以下の float値が異なるファイルで検出されたが、用途不明：

| 値 | 16進数 | 出現ファイル | 位置 |
|----|--------|--------------|------|
| 189.933 | `d9 ee 3d 43` | White, Blue | 0x0154 |
| 5.698 | `ef 55 b6 40` | Red, Blue | 0x014c |
| 11.396 | `ef 55 36 41` | Red | 0x0194 |
| 18.000 | `00 00 90 41` | White | 0x014c |
| 49.396 | `7c 95 45 42` | White | 0x0180 |

これらが色に関連している可能性があるが、確証なし。

## 実装への影響

### アプローチA: テンプレート方式（推奨）

**実装可能度**: ★★★★★

1. 参照ファイル（白、赤、青など）をそのまま使用
2. フォント名、サイズなど位置が確定している部分のみ書き換え
3. 色は参照ファイルから選択

**メリット**:
- すぐに実装できる
- 確実に動作する
- バイナリ構造を完全に理解する必要がない

**デメリット**:
- テンプレートにない色は作れない
- 柔軟性が低い

### アプローチB: 部分的リバースエンジニアリング

**実装可能度**: ★★★☆☆

1. フォント名、サイズ、テキストなどの書き換えは可能
2. 色データは参照ファイルのバイナリブロックをコピー
3. FlatBuffersの再構築ロジックを一部実装

**メリット**:
- ある程度の柔軟性
- 拡張しやすい

**デメリット**:
- 部分的な理解が必要
- バイナリ操作のバグリスク

### アプローチC: 完全解析＆実装

**実装可能度**: ★☆☆☆☆

1. FlatBuffersスキーマを完全に再構築
2. ゼロから正確なバイナリを生成

**メリット**:
- 完全な制御
- あらゆるカスタマイズが可能

**デメリット**:
- 解析に長時間必要
- 実装が複雑
- デバッグが困難

## 次のステップ

### 短期（すぐに実装可能）

1. **テンプレート方式の実装**
   - 白、赤、青、黄色、緑など基本色のテンプレートを用意
   - フォント名・サイズ置換ロジックを実装
   - PRSLから色を選択してテンプレートを適用

### 中期（追加解析が必要）

2. **グラデーション対応**
   - グラデーションファイルの解析を深化
   - RGBA float値の配置ルールを特定
   - グラデーションストップの生成ロジック

3. **ストローク対応**
   - ストロークあり/なしの差分を完全分析
   - ストロークパラメータの格納位置を特定

### 長期（完全解析）

4. **FlatBuffersスキーマの完全再構築**
   - Adobe After Effects SDKの調査
   - FlatBuffers公式ツールによる逆コンパイル
   - 完全なエンコーダー実装

## ツール一覧

作成した解析ツール：

1. `decode_binary_data.py` - バイナリデータの16進ダンプと基本解析
2. `analyze_prtextstyle_complete.py` - XML構造の完全解析
3. `analyze_prsl_complete.py` - PRSLフォーマットの完全解析
4. `compare_binary_formats.py` - 複数ファイルのバイナリ比較
5. `find_color_locations.py` - 色データの位置特定
6. `find_rgb_floats.py` - RGB float パターンの検索
7. `decode_flatbuffers.py` - FlatBuffers構造の解析
8. `search_color_values.py` - 全形式での色値探索
9. `analyze_gradients.py` - グラデーションファイルの解析

## 結論

### 判明したこと

✅ FlatBuffers形式である
✅ フォント名の位置（可変だが特定可能）
✅ フォントサイズの位置（可変だが特定可能）
✅ グラデーションではRGBA float値を使用
✅ ファイル構造は内容によって動的に変化

### 未解決の謎

❓ 単色ファイルの色データの正確な位置
❓ 色データのエンコード方式（単色用）
❓ 各float値の実際の用途
❓ VTableオフセットの完全な意味

### 推奨アクション

**すぐに実装するべき**: テンプレート方式

理由：
1. 実用的で確実
2. ユーザーの要求（PRSLからprtextstyleへの変換）を満たせる
3. 段階的に改良可能

**将来の拡張**: 色データの完全解析

必要になったタイミング：
1. テンプレートにない色が必要になったとき
2. カスタムグラデーションが必要になったとき
3. より高度なカスタマイズが求められたとき

## 参考リンク

- FlatBuffers: https://google.github.io/flatbuffers/
- Adobe After Effects SDK: https://developer.adobe.com/after-effects/
- Premiere Pro SDK: https://developer.adobe.com/premiere-pro/

---

作成者: Claude (Anthropic)
プロジェクト: PRSL to prtextstyle Converter
リポジトリ: Naoking55/telop01
ブランチ: claude/review-premiere-tool-01E5JFci3dJfQRsvf1vNR2JM
