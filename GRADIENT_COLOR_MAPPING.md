# グラデーション色マッピングの完全解析

**解析日**: 2025-12-12
**対象ファイル**: 青白赤グラ 30.prtextstyle (680 bytes)

---

## 🎯 重要な発見

### 色データの2つの形式

1. **RGBA Float形式** (16バイト)
   - 範囲: 0.0 - 1.0
   - 用途: グラデーションストップの色（青のみ検出）
   - 検出: 2箇所
     - 0x0194: RGBA(0.0, 0.0, 1.0, 0.5) = 半透明青
     - 0x01d4: RGBA(0.0, 0.0, 1.0, 0.5) = 半透明青

2. **RGB Bytes形式** (3バイト)
   - 範囲: 0 - 255
   - 用途: グラデーションストップの色（白・赤が検出）
   - 検出箇所:
     - 青: 0x0279 - RGB(0, 0, 255)
     - 白: 0x00b1, 0x00b5, 0x0165, 0x0211, 0x022d, 0x027b (6箇所)
     - 赤: 0x00c3, 0x0167, 0x0213, 0x022f (4箇所)

---

## 📊 グラデーションストップと色の関係

### 検出されたストップ（Position + Alpha ペア）

| オフセット | Position | Alpha | 想定される色 | 近くの色 |
|----------|---------|-------|------------|---------|
| 0x0198 | 0.00 (0%) | 1.00 | 青 | - |
| 0x01b0 | 0.00 (0%) | 0.50 | 青 | - |
| 0x01d8 | 1.00 (100%) | 0.50 | 赤 | **青 RGBA float @ 0x01d4 (-4 bytes)** ❓ |
| 0x01dc | 1.00 (100%) | 0.50 | 赤 | 青 RGBA float @ 0x01d4 (-8 bytes) ❓ |
| 0x0208 | 0.30 (30%) | 0.50 | 白 | 白 @ 0x0211 (+9), 赤 @ 0x0213 (+11) |
| 0x0224 | 0.00 (0%) | 0.50 | 青 | 白 @ 0x022d (+9), 赤 @ 0x022f (+11) |

### 🚨 矛盾点

**問題**: 100% stop (0x01d8) の近くに**青色**がある！
- 期待: 100% = 赤色
- 実際: 青色 RGBA float @ 0x01d4 (ストップの4バイト前)

**仮説**:
1. **グラデーション方向が逆**: 1.0=開始点（青）, 0.0=終了点（赤）？
2. **複数のグラデーション構造**: 異なる用途のグラデーション？
3. **Position値の解釈が誤り**: 0.0-1.0が実際の位置と異なる？

---

## 🔍 詳細な色の位置関係

### 0% ストップ @ 0x0224

```
期待される色: 青
実際の近くの色:
  - 白 @ 0x022d (+9 bytes)
  - 赤 @ 0x022f (+11 bytes)
```

**パターン**: RGB bytes形式で白と赤が**同じ距離**（+9, +11）に配置

### 30% ストップ @ 0x0208

```
期待される色: 白
実際の近くの色:
  - 白 @ 0x0211 (+9 bytes)
  - 赤 @ 0x0213 (+11 bytes)
```

**パターン**: 0%ストップと**同じパターン**（白+9, 赤+11）

### 100% ストップ @ 0x01d8

```
期待される色: 赤
実際の近くの色:
  - 青 RGBA float @ 0x01d4 (-4 bytes) ❓
```

**パターン**: RGBA float形式で青が**ストップの直前**に配置

---

## 🧩 パターン解析

### パターン1: RGBA Float + Stop Position (青色用)

```
構造:
[16バイト: RGBA Float Blue] [8バイト: Position + Alpha]

例:
0x01d4: RGBA(0.0, 0.0, 1.0, 0.5) - 青色
0x01d8: Position=1.0, Alpha=0.5   - ストップ位置
```

### パターン2: Stop Position + RGB Bytes (白・赤用)

```
構造:
[8バイト: Position + Alpha] [+9バイト空き] [3バイト: RGB White] [2バイト空き] [3バイト: RGB Red]

例:
0x0208: Position=0.3, Alpha=0.5   - ストップ位置
0x0211: RGB(255, 255, 255)        - 白色 (+9 bytes)
0x0213: RGB(255, 0, 0)            - 赤色 (+11 bytes)
```

---

## 💡 新仮説: 色データ形式の使い分け

**仮説**: Premiere Proでは色データ形式が2種類混在している
1. **RGBA Float**: アルファチャンネル付きの色（半透明対応）
2. **RGB Bytes**: シンプルな色指定（不透明）

**青色の特別扱い**:
- 青色のみ RGBA Float 形式で格納
- Alpha = 0.5 （半透明）
- 白と赤は RGB Bytes 形式で格納（不透明）

**なぜ青だけ？**:
- テスト時に青だけAlpha値を変更した？
- または青が「開始色」として特別な扱い？

---

## 🔬 次の調査ステップ

### 優先度 HIGH

1. **70%バージョンとの比較**
   - 青白赤グラ 70.prtextstyle を解析
   - 30% vs 70% でストップ位置と色の関係を確認
   - Position値の逆転仮説を検証

2. **4色グラデーションとの比較**
   - 黄赤青白グラ 10.25.75.90.prtextstyle を解析
   - 4色すべてがRGBA Float形式かRGB Bytes形式か確認
   - 複数色のマッピングパターンを特定

3. **単色ファイルとの比較**
   - 青・白・赤の単色スタイルを解析
   - グラデーションとの違いを明確化

### 優先度 MEDIUM

4. **RGB bytes @ 0x0279 の用途解明**
   - なぜこの位置に青色が？
   - どのストップと関連しているのか？

5. **Alpha値のバリエーション調査**
   - Alpha=1.0 vs 0.5 vs 0.3 の意味
   - 不透明度との関係

---

## 📝 未解決の疑問

1. **なぜ100%ストップ(0x01d8)の近くに青色がある？**
   - グラデーション方向が逆？
   - Position値の解釈が間違っている？

2. **なぜ0%と30%ストップの近くに同じ「白+赤」のペアがある？**
   - 共通のカラーパレット？
   - グラデーション両端の色を記録？

3. **RGB bytes @ 0x0279 の役割は？**
   - グラデーションとは無関係？
   - 別の用途（フォント色など）？

---

## ✅ 確定した事実

1. **2つの色データ形式が存在**
   - RGBA Float (16B): 青色用
   - RGB Bytes (3B): 白・赤用

2. **グラデーションストップは8バイト構造**
   - [Position (float 4B)] [Alpha (float 4B)]

3. **色とストップの空間的配置パターン**
   - RGBA Float: ストップの **4バイト前**
   - RGB Bytes: ストップの **+9, +11バイト後**

4. **複数の同じPosition値を持つストップが存在**
   - 0.0が5箇所、1.0が2箇所
   - Alpha値が異なる (1.0 vs 0.5 vs 0.3)

---

**次の解析**: 70%グラデーションとの比較で Position 値と色の関係を確定する
